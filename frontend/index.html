<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ–≤–æ—Å—Ç–Ω–æ–π –ü–æ—Ä—Ç–∞–ª</title>
    
    <!-- React —á–µ—Ä–µ–∑ CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–µ–π -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000/ws';

        // –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        function App() {
            const [news, setNews] = useState([]);
            const [loading, setLoading] = useState(true);
            const [lastUpdate, setLastUpdate] = useState(new Date());
            const [wsConnected, setWsConnected] = useState(false);

            // WebSocket connection
            useEffect(() => {
                let ws = null;
                let reconnectTimeout = null;
                
                const connect = () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        return; // Already connected
                    }
                    
                    ws = new WebSocket(WS_URL);
                    
                    ws.onopen = () => {
                        console.log('üîå WebSocket connected');
                        setWsConnected(true);
                        // Clear any pending reconnection
                        if (reconnectTimeout) {
                            clearTimeout(reconnectTimeout);
                            reconnectTimeout = null;
                        }
                    };
                    
                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('üì° WebSocket message:', data);
                            
                            switch (data.type) {
                                case 'new_news':
                                    // Add new news to the beginning of the list
                                    setNews(prevNews => [...data.news, ...prevNews]);
                                    setLastUpdate(new Date());
                                    console.log(`üì∞ Added ${data.count} new news items`);
                                    break;
                                    
                                case 'news_deleted':
                                    // Remove deleted news
                                    setNews(prevNews => prevNews.filter(n => n.id !== data.news_id));
                                    setLastUpdate(new Date());
                                    console.log(`üóëÔ∏è Deleted news ${data.news_id}`);
                                    break;
                                    
                                case 'all_news_deleted':
                                    // Clear all news
                                    setNews([]);
                                    setLastUpdate(new Date());
                                    console.log('üßπ All news cleared');
                                    break;
                                    
                                default:
                                    console.log('Unknown message type:', data.type);
                            }
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };
                    
                    ws.onclose = () => {
                        console.log('üîå WebSocket disconnected');
                        setWsConnected(false);
                        // Try to reconnect after 5 seconds (increased from 3)
                        reconnectTimeout = setTimeout(() => {
                            console.log('üîÑ Attempting to reconnect...');
                            connect();
                        }, 5000);
                    };
                    
                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        setWsConnected(false);
                    };
                };
                
                // Start initial connection
                connect();

                return () => {
                    if (reconnectTimeout) {
                        clearTimeout(reconnectTimeout);
                    }
                    if (ws) {
                        ws.close();
                    }
                };
            }, []); // Only run once on mount

            // Initial data load
            useEffect(() => {
                const fetchNews = async () => {
                    try {
                        const response = await fetch(`${API_URL}/news`);
                        const data = await response.json();
                        setNews(data);
                        setLastUpdate(new Date());
                        setLoading(false);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:', error);
                        setLoading(false);
                    }
                };
                
                fetchNews();
            }, []);

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="bg-blue-600 text-white shadow-lg">
                        <div className="container mx-auto px-4 py-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold">üì∞ –ù–æ–≤–æ—Å—Ç–Ω–æ–π –ü–æ—Ä—Ç–∞–ª</h1>
                                    <div className="flex items-center mt-1">
                                        <div className={`w-3 h-3 rounded-full mr-2 ${wsConnected ? 'bg-green-400' : 'bg-red-400'}`}></div>
                                        <span className="text-sm">
                                            {wsConnected ? 'üü¢ Real-time –ø–æ–¥–∫–ª—é—á–µ–Ω' : 'üî¥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'}
                                        </span>
                                    </div>
                                </div>
                                <a
                                    href="/admin.html"
                                    className="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg transition text-white font-semibold"
                                >
                                    üîê –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                                </a>
                            </div>
                            <p className="text-blue-200 mt-2">
                                –û–±–Ω–æ–≤–ª–µ–Ω–æ: {lastUpdate.toLocaleTimeString('ru-RU')}
                                {' '}(real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
                            </p>
                        </div>
                    </header>

                    <div className="container mx-auto px-4 py-8">
                        {/* –°–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π */}
                        <div className="mt-8">
                            <h2 className="text-2xl font-bold mb-6">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏</h2>
                            
                            {loading ? (
                                <div className="text-center py-12">
                                    <div className="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                                </div>
                            ) : news.length === 0 ? (
                                <div className="bg-white rounded-lg shadow p-8 text-center">
                                    <p className="text-gray-500">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è.</p>
                                </div>
                            ) : (
                                <div className="grid gap-6">
                                    {news.map(item => (
                                        <NewsCard key={item.id} news={item} />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–æ–≤–æ—Å—Ç–∏
        function NewsCard({ news }) {
            const date = new Date(news.created_at);
            
            return (
                <div className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
                    <div className="flex justify-between items-start mb-3">
                        <h3 className="text-xl font-semibold text-gray-800">{news.title}</h3>
                        <span className="text-sm text-gray-500 whitespace-nowrap ml-4">
                            {date.toLocaleString('ru-RU')}
                        </span>
                    </div>
                    <p className="text-gray-600 leading-relaxed">{news.content}</p>
                    <div className="mt-4 text-sm text-gray-400">
                        ID: {news.id}
                    </div>
                </div>
            );
        }


        // –†–µ–Ω–¥–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>